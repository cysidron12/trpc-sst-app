import { observable } from '@trpc/server/observable';

/* istanbul ignore file -- @preserve */ // We're not actually exporting this link
/**
 * @see https://trpc.io/docs/v11/client/links/retryLink
 */ function retryLink(opts) {
    // initialized config
    return ()=>{
        // initialized in app
        return ({ op , next  })=>{
            // initialized for request
            return observable((observer)=>{
                let next$;
                attempt(1);
                function attempt(attempts) {
                    next$ = next(op).subscribe({
                        error (error) {
                            const shouldRetry = opts.retry({
                                op,
                                attempts,
                                error
                            });
                            if (shouldRetry) {
                                attempt(attempts + 1);
                            } else {
                                observer.error(error);
                            }
                        },
                        next (result) {
                            observer.next(result);
                        },
                        complete () {
                            observer.complete();
                        }
                    });
                }
                return ()=>{
                    next$.unsubscribe();
                };
            });
        };
    };
}

export { retryLink };
